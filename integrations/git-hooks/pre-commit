#!/bin/bash

# Layered Authorship Framework - Git Pre-commit Hook
# Primary Author: Sean Christopher Southwick
# Computational Assistance: Non-human automated systems provided git hook structure

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}üîç Layered Authorship Framework - Pre-commit Check${NC}"

# Get the root directory of the git repository
GIT_ROOT=$(git rev-parse --show-toplevel)

# Check if framework tools exist
FRAMEWORK_SCRIPT=""
if [[ -f "$GIT_ROOT/scripts/add-framework-recursive.js" ]]; then
    FRAMEWORK_SCRIPT="node $GIT_ROOT/scripts/add-framework-recursive.js"
elif [[ -f "$GIT_ROOT/scripts/add_framework_recursive.py" ]]; then
    FRAMEWORK_SCRIPT="python3 $GIT_ROOT/scripts/add_framework_recursive.py"
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check for files that need attribution
NEEDS_ATTRIBUTION=()
ATTRIBUTION_MARKERS=("Layered Authorship Framework" "Primary Author: Sean Christopher Southwick")

for file in $STAGED_FILES; do
    # Skip if file doesn't exist (deleted files)
    [[ ! -f "$file" ]] && continue
    
    # Check file extension
    case "$file" in
        *.js|*.jsx|*.ts|*.tsx|*.py|*.html|*.md|*.yml|*.yaml)
            # Check if file has attribution
            has_attribution=false
            for marker in "${ATTRIBUTION_MARKERS[@]}"; do
                if grep -q "$marker" "$file" 2>/dev/null; then
                    has_attribution=true
                    break
                fi
            done
            
            if [[ "$has_attribution" == "false" ]]; then
                NEEDS_ATTRIBUTION+=("$file")
            fi
            ;;
    esac
done

# If files need attribution, offer to add it
if [[ ${#NEEDS_ATTRIBUTION[@]} -gt 0 ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  The following files are missing Layered Authorship Framework attribution:${NC}"
    for file in "${NEEDS_ATTRIBUTION[@]}"; do
        echo "  - $file"
    done
    
    if [[ -n "$FRAMEWORK_SCRIPT" ]]; then
        echo ""
        read -p "Add attribution automatically? (y/N): " -n 1 -r
        echo ""
        
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${YELLOW}üìù Adding attribution to files...${NC}"
            
            # Add attribution to each file
            for file in "${NEEDS_ATTRIBUTION[@]}"; do
                # Create a temporary script to process single file
                temp_dir=$(mktemp -d)
                cp "$file" "$temp_dir/"
                
                if [[ "$FRAMEWORK_SCRIPT" == *"node"* ]]; then
                    node "$GIT_ROOT/scripts/add-framework-recursive.js" "$temp_dir" >/dev/null 2>&1
                else
                    python3 "$GIT_ROOT/scripts/add_framework_recursive.py" "$temp_dir" >/dev/null 2>&1
                fi
                
                # Copy back if modified
                if [[ -f "$temp_dir/$(basename "$file")" ]]; then
                    cp "$temp_dir/$(basename "$file")" "$file"
                    git add "$file"
                    echo -e "${GREEN}  ‚úÖ Added attribution to $file${NC}"
                fi
                
                rm -rf "$temp_dir"
            done
            
            echo -e "${GREEN}‚úÖ Attribution added successfully${NC}"
        else
            echo -e "${RED}‚ùå Commit aborted. Please add attribution manually or use:${NC}"
            echo "   $FRAMEWORK_SCRIPT"
            exit 1
        fi
    else
        echo -e "${RED}‚ùå Framework scripts not found. Please add attribution manually.${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}‚úÖ All staged files have proper attribution${NC}"
exit 0
